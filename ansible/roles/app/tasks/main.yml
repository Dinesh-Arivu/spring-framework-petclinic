---
- name: Ensure apt cache refreshed
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Ensure 'universe' repository is enabled (Ubuntu)
  apt_repository:
    repo: "deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }} universe"
    state: present
  when: ansible_distribution == "Ubuntu"

- name: Refresh apt cache after repository change
  apt:
    update_cache: yes
  when: ansible_distribution == "Ubuntu"

- name: Check if tomcat10 package is available
  command: apt-cache policy tomcat10
  register: tomcat10_policy
  changed_when: false
  failed_when: false

- name: Set fact tomcat_pkg_available
  set_fact:
    tomcat_pkg_available: "{{ (tomcat10_policy.stdout is defined) and (tomcat10_policy.stdout.find('Candidate: (none)') == -1) and (tomcat10_policy.stdout | length > 0) }}"

- name: Set Tomcat paths and service name based on installation method
  set_fact:
    tomcat_config_dir: "{{ '/etc/tomcat10' if tomcat_pkg_available else '/opt/tomcat/latest/bin' }}"
    tomcat_webapps_dir: "{{ '/var/lib/tomcat10/webapps' if tomcat_pkg_available else '/opt/tomcat/latest/webapps' }}"
    tomcat_user: "{{ 'tomcat' if tomcat_pkg_available else 'root' }}"
    tomcat_group: "{{ 'tomcat' if tomcat_pkg_available else 'root' }}"
    tomcat_service_name: "{{ 'tomcat10' if tomcat_pkg_available else 'tomcat' }}"

- name: Install Java (OpenJDK 17)
  apt:
    name: openjdk-17-jdk
    state: present

- name: Install Tomcat via apt when available
  apt:
    name: tomcat10
    state: present
  when: tomcat_pkg_available

- name: Install Tomcat (manual archive) when tomcat10 package is not available
  block:
    - name: Install utilities and Java for manual Tomcat install
      apt:
        name:
          - wget
          - tar
          - default-jdk
        state: present

    - name: Download Tomcat 10 tarball
      get_url:
        url: "https://archive.apache.org/dist/tomcat/tomcat-10/v10.1.14/bin/apache-tomcat-10.1.14.tar.gz"
        dest: /tmp/tomcat10.tar.gz
        mode: '0644'

    - name: Create /opt/tomcat directory
      file:
        path: /opt/tomcat
        state: directory
        mode: '0755'

    - name: Extract Tomcat archive
      unarchive:
        src: /tmp/tomcat10.tar.gz
        dest: /opt/tomcat
        remote_src: yes

    - name: Symlink /opt/tomcat/latest to the extracted Tomcat
      file:
        src: /opt/tomcat/apache-tomcat-10.1.14
        dest: /opt/tomcat/latest
        state: link

    - name: Create systemd unit for Tomcat
      copy:
        dest: /etc/systemd/system/tomcat.service
        content: |
          [Unit]
          Description=Apache Tomcat 10
          After=network.target

          [Service]
          Type=forking
          ExecStart=/opt/tomcat/latest/bin/startup.sh
          ExecStop=/opt/tomcat/latest/bin/shutdown.sh
          User=root
          Group=root
          Restart=on-failure

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Start tomcat systemd service
      service:
        name: tomcat
        state: started
        enabled: yes
  when: not tomcat_pkg_available

- name: Ensure Tomcat is running (package-managed path may use tomcat10 service name)
  service:
    name: "{{ tomcat_service_name }}"
    state: started
    enabled: yes

- name: Install nginx
  apt:
    name: nginx
    state: present

- name: Configure Nginx as reverse proxy for Tomcat
  copy:
    dest: /etc/nginx/sites-available/petclinic
    content: |
      server {
          listen 80;
          location / {
              proxy_pass http://127.0.0.1:8080/;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
          }
      }
  notify: reload nginx

- name: Enable nginx site
  file:
    src: /etc/nginx/sites-available/petclinic
    dest: /etc/nginx/sites-enabled/petclinic
    state: link

- name: Remove default site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: reload nginx

- name: Create Tomcat setenv.sh with DB connection properties
  template:
    src: setenv.sh.j2
    dest: "{{ tomcat_config_dir }}/setenv.sh"
    owner: root
    mode: '0755'
  vars:
    db_host: "{{ hostvars[groups['db'][0]]['ansible_host'] | default(hostvars[groups['db'][0]]['inventory_hostname']) }}"
    db_port: 3306
    db_name: petclinic
    db_user: petclinic
    db_pass: petclinic

- name: Upload petclinic.war to Tomcat webapps
  copy:
    src: ../../../../spring-framework-petclinic/target/petclinic.war
    dest: "{{ tomcat_webapps_dir }}/petclinic.war"
    owner: "{{ tomcat_user }}"
    group: "{{ tomcat_group }}"
    mode: '0644'
  notify: restart tomcat

- name: Wait for app to be deployed (Tomcat auto-deploy)
  wait_for:
    host: 127.0.0.1
    port: 8080
    delay: 5
    timeout: 120
